import { useNavigation } from "@react-navigation/native";
import { useEffect, useLayoutEffect } from "react";
import { View } from "react-native";

import useScreenDimensions from "../hooks/useScreenDimensions";

import { onAuthStateChanged } from "firebase/auth";
import { FIREBASE_AUTH } from "../firebaseConfig";
import { useDispatch } from "react-redux";
import { clearUser, setUser } from "../redux/actions";
import { getUserData } from "../utils/userActions";

import Svg, { Path } from "react-native-svg";

// Fixed

const LoadingScreen = () => {
  const navigation = useNavigation();
  const dispatch = useDispatch();
  const { windowWidth } = useScreenDimensions();

  useLayoutEffect(() => {
    navigation.setOptions({
      headerShown: false,
    });
  }, []);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(FIREBASE_AUTH, async (user) => {
      if (user) {
        console.log(user);
        const userData = await getUserData(user.uid);
        dispatch(setUser({ email: user.email, uid: user.uid, ...userData }));

        if (userData.partyUID !== undefined && userData.partyUID !== null) {
          // If they are registered at some party pool then we need to navigate them to the correct screen
          navigation.navigate("JoinPartyStack");
        } else {
          navigation.navigate("NotJoinPartyStack");
        }
      } else {
        console.log("No User :(");
        dispatch(clearUser()); // dispatch your logout action
        navigation.navigate("Welcome");
      }
    });

    // cleanup method
    return unsubscribe;
  }, [dispatch]);

  return (
    <View
      style={{
        flex: 1,
        alignItems: "center",
        justifyContent: "center",
        backgroundColor: "#5F29C7",
      }}
    >
      <Svg
        width={windowWidth * 0.8}
        height="176"
        viewBox="0 0 450 176"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <Path
          d="M156.259 136.328L156.161 136.426C157.463 136.751 158.017 137.956 157.821 140.039C157.626 142.188 156.942 143.262 155.77 143.262H102.938C101.701 143.262 101.018 142.188 100.888 140.039C100.822 137.891 101.311 136.686 102.352 136.426C104.631 136.035 106.454 135.547 107.821 134.961C109.188 134.375 110.523 133.333 111.825 131.836C113.127 130.339 113.615 128.223 113.29 125.488C112.964 122.689 111.955 119.238 110.263 115.137L108.114 110.156C107.203 107.878 105.933 106.445 104.306 105.859C102.678 105.273 100.171 104.98 96.786 104.98H55.9657C52.7105 104.98 50.2366 105.273 48.5439 105.859C46.9163 106.445 45.6142 107.878 44.6376 110.156L42.6845 115.137C40.8616 119.303 39.9176 122.721 39.8525 125.391C39.7222 128.19 40.3407 130.306 41.7079 131.738C43.0751 133.171 44.5725 134.18 46.2001 134.766C47.8928 135.352 50.1389 135.84 52.9384 136.23C54.2405 136.556 54.7939 137.76 54.5985 139.844C54.4032 141.992 53.622 143.066 52.2548 143.066H9.09073C7.91886 143.066 7.23526 141.992 7.03995 139.844C6.84464 137.695 7.36547 136.491 8.60245 136.23C13.1597 135.449 16.8381 133.724 19.6376 131.055C22.372 128.385 25.4644 123.047 28.9149 115.039L62.8017 37.5C69.5725 22.0703 72.9579 10.9375 72.9579 4.10156C72.9579 3.38542 75.3017 2.53906 79.9892 1.5625C84.7418 0.585938 87.2483 0.423177 87.5087 1.07422L136.239 114.844C139.625 122.786 142.75 128.19 145.614 131.055C148.479 133.919 152.027 135.677 156.259 136.328ZM95.3212 93.8477L95.1259 93.9453C95.9071 93.9453 96.8186 93.8802 97.8603 93.75C98.5764 93.6849 99.1949 93.3919 99.7157 92.8711C100.237 92.3503 100.302 91.6341 99.911 90.7227L76.4735 34.7656L52.8407 90.7227C52.385 91.8945 52.6129 92.7083 53.5243 93.1641C54.4358 93.6198 55.7704 93.8477 57.5282 93.8477H95.3212Z"
          fill="#FCFBFC"
        />
        <Path
          d="M286.727 3.125L286.825 3.22266C287.997 3.22266 288.681 4.29688 288.876 6.44531C289.071 8.59375 288.583 9.79818 287.411 10.0586C283.44 10.7096 279.599 12.6628 275.888 15.918C272.177 19.1081 268.043 24.2188 263.485 31.25L231.454 81.25V118.457C231.454 124.837 233.082 129.199 236.337 131.543C239.592 133.952 244.768 135.579 251.864 136.426C252.255 136.426 252.45 137.012 252.45 138.184C252.45 139.225 252.287 140.397 251.962 141.699C251.636 142.871 251.246 143.457 250.79 143.457H188.192C187.737 143.457 187.313 142.871 186.923 141.699C186.532 140.527 186.337 139.355 186.337 138.184C186.337 137.012 186.565 136.426 187.02 136.426C194.377 135.319 199.651 133.626 202.841 131.348C206.031 129.004 207.626 124.707 207.626 118.457V82.0312L173.934 31.4453C169.117 24.0885 165.048 18.8477 161.727 15.7227C158.472 12.6628 154.761 10.7747 150.595 10.0586C149.293 9.73307 148.739 8.52865 148.934 6.44531C149.13 4.29688 149.911 3.22266 151.278 3.22266H204.11C205.347 3.22266 206.031 4.29688 206.161 6.44531C206.226 8.59375 205.705 9.79818 204.599 10.0586C199.911 10.8398 197.144 12.9232 196.298 16.3086C195.451 19.7591 197.014 24.7396 200.985 31.25L226.376 69.043L250.79 31.25C254.631 24.7396 255.803 19.7591 254.306 16.3086C252.808 12.8581 249.195 10.7422 243.466 9.96094C242.164 9.63542 241.61 8.43099 241.806 6.34766C242.001 4.19922 242.684 3.125 243.856 3.125H286.727Z"
          fill="#FCFBFC"
        />
        <Path
          d="M370.028 146.387H369.931C349.162 146.387 331.942 139.518 318.27 125.781C304.599 111.979 297.763 94.694 297.763 73.9258C297.763 53.2878 304.501 35.8073 317.977 21.4844C331.454 7.16146 348.934 0 370.419 0C391.382 0 408.668 6.83594 422.274 20.5078C435.881 34.2448 442.684 51.4648 442.684 72.168C442.684 92.9362 435.946 110.514 422.47 124.902C408.993 139.225 391.513 146.387 370.028 146.387ZM377.743 132.812L377.352 133.008C382.105 133.008 386.76 132.161 391.317 130.469C395.809 128.776 400.204 126.139 404.501 122.559C408.798 118.978 412.216 113.802 414.755 107.031C417.294 100.26 418.563 92.4479 418.563 83.5938C418.563 63.8021 412.899 47.2331 401.571 33.8867C390.243 20.4753 377.157 13.7695 362.313 13.7695C357.496 13.7695 352.873 14.5833 348.446 16.2109C344.019 17.8385 339.69 20.4753 335.458 24.1211C331.291 27.7018 327.938 32.8125 325.399 39.4531C322.86 46.0938 321.591 53.9062 321.591 62.8906C321.591 82.6823 327.255 99.2839 338.583 112.695C349.911 126.107 362.964 132.812 377.743 132.812Z"
          fill="#FCFBFC"
        />
        <Path
          d="M0 164.5C0 159.253 4.25329 155 9.5 155H440.5C445.747 155 450 159.253 450 164.5V164.5C450 169.747 445.747 174 440.5 174H9.50001C4.2533 174 0 169.747 0 164.5V164.5Z"
          fill="#FE6244"
        />
      </Svg>
    </View>
  );
};

export default LoadingScreen;
